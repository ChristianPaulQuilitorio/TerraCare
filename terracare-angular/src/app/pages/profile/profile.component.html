<div class="profile-container">
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner"></div>
    <p>Loading your profile...</p>
  </div>

  <!-- Profile Content -->
  <div *ngIf="!loading && user" class="profile-content">
    <!-- Simple cropper dialog -->
    <div *ngIf="cropDialogOpen" class="modal-backdrop">
      <div class="modal">
        <h3>Crop your photo</h3>
        <div class="cropper" style="width: 320px; height: 320px; margin: 12px auto; position: relative; overflow: hidden; border-radius: 8px; background: #000;">
          <img *ngIf="cropSrc" [src]="cropSrc" alt="crop" style="position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); max-width:none; width:auto; height:100%;"/>
        </div>
        <div *ngIf="cropError" class="message error" style="margin-top:8px;">{{ cropError }}</div>
        <div class="form-actions" style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn secondary" (click)="cancelCrop()" [disabled]="cropping">Cancel</button>
          <button class="btn primary" (click)="confirmCrop()" [disabled]="cropping">{{ cropping ? 'Processing...' : 'Save' }}</button>
        </div>
      </div>
    </div>
    <!-- Header Section -->
    <div class="profile-header">
      <div class="avatar">
        <img *ngIf="avatarUrl; else noAvatar" [src]="avatarUrl" alt="avatar" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover;"/>
        <ng-template #noAvatar>
          <span class="avatar-text">{{ user.fullName ? user.fullName.charAt(0).toUpperCase() : 'U' }}</span>
        </ng-template>
      </div>
      <div class="header-info">
        <h1>{{ user.fullName || 'User Profile' }}</h1>
        <p class="user-email">{{ user.email }}</p>
        <p class="member-since">Member since {{ formatDate(user.createdAt) }}</p>
      </div>
      <div class="header-actions">
        <button 
          *ngIf="!editing" 
          class="btn primary" 
          (click)="startEditing()"
        >
          Edit Profile
        </button>
        <label class="btn secondary" style="margin-left:8px; cursor:pointer;">
          {{ avatarUploading ? 'Uploading...' : 'Change Photo' }}
          <input type="file" accept="image/*" (change)="onAvatarFileSelected($event)" style="display:none;" [disabled]="avatarUploading" />
        </label>
        <button class="btn danger" style="margin-left:8px;" (click)="removeAvatar()" [disabled]="avatarUploading || !avatarUrl">Remove Photo</button>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div *ngIf="message" class="message" [class.success]="!message.includes('Failed')" [class.error]="message.includes('Failed')">
      {{ message }}
    </div>

    <!-- Profile Information -->
    <div class="profile-sections">
      <!-- Basic Information -->
      <div class="section">
        <h2>Basic Information</h2>
        
        <!-- View Mode -->
        <div *ngIf="!editing" class="info-view">
          <div class="info-item">
            <label>Full Name</label>
            <span>{{ user.fullName || 'Not provided' }}</span>
          </div>
          <div class="info-item">
            <label>Email Address</label>
            <span>{{ user.email }}</span>
          </div>
          <div class="info-item">
            <label>User ID</label>
            <span class="user-id">{{ user.id }}</span>
          </div>
        </div>

        <!-- Edit Mode -->
        <form *ngIf="editing" [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="edit-form">
          <div class="form-group">
            <label for="fullName">Full Name</label>
            <input 
              type="text" 
              id="fullName" 
              formControlName="fullName"
              placeholder="Enter your full name"
            >
            <small *ngIf="profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched" class="error">
              Full name is required (minimum 2 characters)
            </small>
          </div>

          <div class="form-group">
            <label for="email">Email Address</label>
            <input 
              type="email" 
              id="email" 
              formControlName="email"
              placeholder="Enter your email"
            >
            <small *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched" class="error">
              Please enter a valid email address
            </small>
          </div>

          <div class="form-actions">
            <button 
              type="button" 
              class="btn secondary" 
              (click)="cancelEditing()"
              [disabled]="saving"
            >
              Cancel
            </button>
            <button 
              type="submit" 
              class="btn primary" 
              [disabled]="profileForm.invalid || saving"
            >
              {{ saving ? 'Saving...' : 'Save Changes' }}
            </button>
          </div>
        </form>
      </div>

      <!-- Account Actions -->
      <div class="section">
        <h2>Account Actions</h2>
        <div class="action-buttons">
          <button class="btn secondary" routerLink="/home">
            üè† Back to Dashboard
          </button>
          <button class="btn secondary" routerLink="/dashboard">
            üìä View My Stats
          </button>
          <button class="btn danger" (click)="logout()">
            üö™ Sign Out
          </button>
        </div>
      </div>

      <!-- App Statistics (Demo Data) -->
      <div class="section">
        <h2>Your TerraCare Impact</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">5</div>
            <div class="stat-label">Challenges Completed</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">1.2kg</div>
            <div class="stat-label">CO‚ÇÇ Saved</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">12</div>
            <div class="stat-label">Articles Read</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">3</div>
            <div class="stat-label">Forum Posts</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Not Logged In State -->
  <div *ngIf="!loading && !user" class="not-logged-in">
    <h2>Please Log In</h2>
    <p>You need to be logged in to view your profile.</p>
    <button class="btn primary" routerLink="/login">Go to Login</button>
  </div>
</div>
