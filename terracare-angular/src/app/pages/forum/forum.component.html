
<app-navbar />

<section class="forum">
  <h1>Community Forum</h1>

  <!-- Create post box (Facebook-like) -->
  <div class="create-post">
    <div class="cp-top">
      <div class="avatar">
        <span class="avatar-text">{{ userName ? (userName.charAt(0) | uppercase) : 'U' }}</span>
      </div>
      <textarea id="forum-draft" [(ngModel)]="draftText" placeholder="What's on your mind, {{ userName || 'User' }}?" rows="2"
        (keydown)="onDraftKeydown($event)" (input)="autoResize($event)" [disabled]="!isLoggedIn"></textarea>
    </div>
    <div class="cp-actions">
      <div class="quick-actions" style="display:flex; gap:8px; align-items:center;">
        <button class="qa" (click)="triggerFileInput('image')" [disabled]="!isLoggedIn"><span class="icon">ğŸ–¼ï¸</span> Photo/video</button>
        <button class="qa" (click)="triggerFileInput('video')" [disabled]="!isLoggedIn"><span class="icon">ğŸï¸</span> Reel</button>
        <input #fileInput type="file" accept="image/*,video/*" style="display:none" (change)="onFileSelected($event)">
      </div>
      <div class="post-actions" style="text-align:right;">
        <button class="btn primary" (click)="publishPost()" [disabled]="!draftText.trim() || !isLoggedIn || loading">Post</button>
      </div>
    </div>
    <div class="attachment-preview" *ngIf="attachedPreview">
      <div class="preview">
        <img *ngIf="attachedPreviewType==='image'" [src]="attachedPreview" alt="preview">
        <video *ngIf="attachedPreviewType==='video'" [src]="attachedPreview" controls></video>
      </div>
      <button class="btn" (click)="clearAttachment()">Remove attachment</button>
    </div>
    <div *ngIf="errorMsg" style="color:#c00; margin-top:8px;">{{ errorMsg }}</div>
  </div>

  <div class="discussion-list">
    <div class="discussion" *ngFor="let p of posts">
      <h3>
        {{ p.author_name || (p.author_id | slice:0:8) }} Â· {{ formatTimestamp(p.created_at) }}
        <button *ngIf="isLoggedIn && userId === p.author_id" class="btn" style="float:right; background:#c62828" (click)="onDelete(p)">Delete</button>
      </h3>
      <p>{{ p.content }}</p>
      <div *ngIf="p.attachment_url">
        <img *ngIf="p.attachment_type==='image'" [src]="p.attachment_url" alt="attachment" style="max-width:320px; max-height:180px; margin-top:8px;">
        <video *ngIf="p.attachment_type==='video'" [src]="p.attachment_url" controls style="max-width:320px; max-height:180px; margin-top:8px;"></video>
      </div>
    </div>
  </div>
</section>
