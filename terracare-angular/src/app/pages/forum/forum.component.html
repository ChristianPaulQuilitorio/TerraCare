<app-navbar />

<section class="forum">
  <h1>Community Forum</h1>

  <!-- Create post box (Facebook-like) -->
  <div class="create-post">
    <div class="cp-top">
      <div class="avatar">
        <span class="avatar-text">{{ userName ? (userName.charAt(0) | uppercase) : 'U' }}</span>
      </div>
      <textarea id="forum-draft" [(ngModel)]="draftText" placeholder="What's on your mind, {{ userName || 'User' }}?" rows="2"
        (keydown)="onDraftKeydown($event)" (input)="autoResize($event)"></textarea>
    </div>
    <div class="cp-actions">
      <div class="quick-actions" style="display:flex; gap:8px; align-items:center;">
        <button class="qa" (click)="triggerFileInput('image')"><span class="icon">üñºÔ∏è</span> Photo/video</button>
        <button class="qa" (click)="triggerFileInput('video')"><span class="icon">üéûÔ∏è</span> Reel</button>
        <input #fileInput type="file" accept="image/*,video/*" style="display:none" (change)="onFileSelected($event)">
      </div>
      <div class="post-actions" style="text-align:right;">
        <button class="btn primary" (click)="publishPost()" [disabled]="!draftText.trim()">Post</button>
      </div>
    </div>
    <div class="attachment-preview" *ngIf="attachedPreview">
      <div class="preview">
        <img *ngIf="attachedPreviewType==='image'" [src]="attachedPreview" alt="preview">
        <video *ngIf="attachedPreviewType==='video'" [src]="attachedPreview" controls></video>
      </div>
      <button class="btn" (click)="clearAttachment()">Remove attachment</button>
    </div>
  </div>

  <div class="discussion-list">
    <div class="discussion" *ngFor="let p of posts">
      <div class="discussion__header" style="display:flex; align-items:center; gap:8px;">
        <div class="avatar" style="width:32px; height:32px; border-radius:50%; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#eee; font-weight:600;">
          <img *ngIf="p.author_avatar_url" [src]="p.author_avatar_url" alt="avatar" style="width:100%; height:100%; object-fit:cover;"/>
          <span *ngIf="!p.author_avatar_url">{{ (p.author_name || p.author_id).charAt(0) | uppercase }}</span>
        </div>
        <div>
          <strong>{{ p.author_name || (p.author_id | slice:0:8) }}</strong>
          <span class="muted">¬∑ {{ formatTimestamp(p.created_at) }}</span>
        </div>
      </div>
      <div class="discussion__body">
        <p style="white-space:pre-wrap;">{{ p.content }}</p>
        <div class="media" *ngIf="p.attachment_url">
          <img *ngIf="p.attachment_type==='image'" [src]="p.attachment_url" alt="attachment" style="max-width:100%; border-radius:8px;"/>
          <video *ngIf="p.attachment_type==='video'" [src]="p.attachment_url" controls style="max-width:100%; border-radius:8px;"></video>
        </div>
      </div>
      <div class="discussion__actions">
        <button class="btn danger" *ngIf="isLoggedIn && userId===p.author_id" (click)="onDelete(p)">Delete</button>
      </div>
    </div>
  </div>
</section>
