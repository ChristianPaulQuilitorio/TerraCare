<app-navbar></app-navbar>

<div class="dashboard-container">
  <main class="dashboard-content">
    <header class="dashboard-header">
      <div>
        <h1>Dashboard Overview</h1>
        <p class="subtitle">Quick snapshot of your activity and resources</p>
      </div>
      <div class="header-actions">
        <!-- Use routerLink on the button element to avoid nested anchor issues -->
        <button class="btn btn-primary" routerLink="/challenges">Create Challenge</button>
      </div>
    </header>

    <section class="stats-grid">
      <article class="card highlight">
        <h3>Active Challenges</h3>
        <p class="number">{{ activeCount }}</p>
        <p class="muted">Challenges you’ve joined and are actively working on.</p>
        <div *ngIf="activeChallenges && activeChallenges.length" style="margin-top:10px;">
          <strong>Current:</strong>
          <div class="active-preview">
            <div *ngFor="let ac of activeChallenges.slice(0,1)">
              <h4 style="margin:6px 0 4px 0">{{ ac.title || ac.name || ac.id }}</h4>
              <p class="muted small">{{ ac.description || ac.short_description || '' }}</p>
              <div class="progress-bar small"><div class="progress-fill" [style.width.%]="getChallengePercent(ac)"></div></div>
                <p class="muted small">{{ getChallengePercent(ac) }}% complete</p>
                <div style="margin-top:8px; display:flex; gap:8px;">
                  <button class="btn" [routerLink]="['/challenges/progress']" [queryParams]="{ id: ac.id }">View Detailed Progress</button>
                  <button class="btn outline" (click)="joinChallenge(ac)">Join</button>
                </div>
            </div>
          </div>
        </div>
      </article>

      <article class="card">
        <h3>Available Resources</h3>
        <p class="number orange">{{ knowledgeCount }}</p>
        <p class="muted">Articles, guides, and videos in the Knowledge Hub.</p>
      </article>

      <article class="card">
        <h3>Recent Forum Activity</h3>
        <p class="number">{{ forumCount }}</p>
        <p class="muted">New posts or replies in the community forum.</p>
      </article>

      <article class="card stretch">
        <h3>Engagement — Leaderboard</h3>
        <div class="leaderboard-card">
          <ol class="leaderboard-grid">
            <li *ngFor="let lb of leaderboard; index as i">
              <div class="rank">#{{ i + 1 }}</div>
              <div class="info">
                <div class="name">{{ lb.name }}</div>
                <div class="meta muted">{{ lb.user_id }}</div>
              </div>
              <div class="score">{{ lb.score }}</div>
            </li>
          </ol>
        </div>
        <p class="muted">Top users by challenges completed (from recent activity).</p>
      </article>
    </section>

    <section class="lower-row">
      <div class="recent-activity card">
        <h3>Recent Activity (last 24h)</h3>
        <ul>
          <li *ngFor="let a of recentActivity">
            <strong>{{ a.user }}</strong>
            <span class="muted"> • </span>
            <em>{{ a.title }}</em>
            <span class="time">{{ a.time | date:'short' }}</span>
          </li>
          <li *ngIf="!recentActivity || recentActivity.length === 0" class="muted">No activity in the last 24 hours.</li>
        </ul>
      </div>
      <aside class="quick-actions card">
        <h3>Quick Actions</h3>
        <div class="actions-grid">
          <button class="btn icon">+ Join</button>
          <button class="btn icon outline">+ Post</button>
          <button class="btn icon">+ Resource</button>
        </div>

        <div class="leaderboard" style="margin-top:18px;">
          <h4>Leaderboard</h4>
          <ol class="leader-list">
            <li *ngFor="let lb of leaderboard">
              <span class="leader-name">{{ lb.name }}</span>
              <span class="leader-score">{{ lb.score }}</span>
            </li>
          </ol>
        </div>
      </aside>
    </section>
  </main>
</div>
