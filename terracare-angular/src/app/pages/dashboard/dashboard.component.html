<div class="dashboard-container mat-app-background">
  <main class="dashboard-content">
    <header class="dashboard-header">
      <div>
        <h1>Dashboard Overview</h1>
        <p class="subtitle">Quick snapshot of your activity and resources</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" routerLink="/challenges">Create Challenge</button>
      </div>
    </header>

    <section class="stats-grid">
      <mat-card class="highlight">
        <mat-card-header>
          <mat-card-title>Active Challenges</mat-card-title>
          <mat-card-subtitle>{{ activeCount }} Joined</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p class="muted">Challenges you’ve joined and are actively working on.</p>
          <div *ngIf="featuredActive as ac" class="active-preview">
            <h4 class="challenge-title">{{ ac.title || ac.name || ac.id }}</h4>
            <p class="muted small">Joined {{ ac.joined_at | date:'shortDate' }} • {{ getChallengePercent(ac) }}% complete</p>
            <mat-progress-bar mode="determinate" color="primary" [value]="getChallengePercent(ac)"></mat-progress-bar>
            <div class="action-row" style="margin-top:8px;">
              <button mat-stroked-button color="primary" [routerLink]="['/challenges/progress']" [queryParams]="{ id: ac.id }">Detailed Progress</button>
            </div>
            <div *ngIf="activeChallenges.length > 1" class="muted small" style="margin-top:6px;">Tracking {{ activeChallenges.length }} active challenges (showing most recent).</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Available Resources</mat-card-title>
          <mat-card-subtitle>{{ knowledgeCount }} Items</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p class="muted">Articles, guides, and videos in the Knowledge Hub.</p>
        </mat-card-content>
      </mat-card>

      <mat-card>
        <mat-card-header>
          <mat-card-title>Recent Forum Activity</mat-card-title>
          <mat-card-subtitle>{{ forumCount }} Posts</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p class="muted">New posts or replies in the community forum.</p>
        </mat-card-content>
      </mat-card>

      <mat-card class="environment">
        <mat-card-header>
          <mat-card-title>Environment — Analytics</mat-card-title>
          <mat-card-subtitle>Real-time indicators</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <div class="env-grid">
            <div class="env-item">
              <div class="label">Trees planted</div>
              <div class="value">{{ treesPlanted | number }}</div>
              <div class="muted small" *ngIf="treesPlantedSource">Source: {{ treesPlantedSource }}</div>
            </div>
            <div class="env-item">
              <div class="label">Wildlife activity</div>
              <div class="value">{{ wildlifeSpecies.length }} species</div>
              <div class="muted small">{{ wildlifeSpecies.slice(0,4).join(', ') }}<span *ngIf="wildlifeSpecies.length>4">, …</span></div>
              <div class="muted small" *ngIf="wildlifeLastUpdated">Updated: {{ wildlifeLastUpdated | date:'short' }}</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stretch">
        <mat-card-header>
          <mat-card-title>Engagement — Leaderboard</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <ol class="leaderboard-grid">
            <li *ngFor="let lb of (leaderboard | slice:0:3); index as i">
              <div class="rank">#{{ i + 1 }}</div>
              <div class="avatar-small">
                <img *ngIf="lb.avatarUrl; else lbInitial" [src]="lb.avatarUrl" alt="avatar" />
                <ng-template #lbInitial>
                  <div class="avatar-initial">{{ lb.name ? lb.name.charAt(0) : (lb.user_id || '?').charAt(0) }}</div>
                </ng-template>
              </div>
              <div class="info">
                <div class="name">{{ lb.name }}</div>
                <div class="meta muted">{{ lb.user_id }}</div>
              </div>
              <div class="score">{{ lb.score }}</div>
            </li>
          </ol>
          <p class="muted">Top 3 users by challenges completed (from recent activity).</p>
          <div *ngIf="leaderboard.length > 3" class="see-more-wrapper" style="margin-top:8px;">
            <button mat-stroked-button color="primary" routerLink="/leaderboard">See more</button>
          </div>
        </mat-card-content>
      </mat-card>
    </section>

    <section class="lower-row">
      <mat-card class="map-card">
        <mat-card-header>
          <mat-card-title>Plantings Map — Philippines</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <app-plantings-map></app-plantings-map>
        </mat-card-content>
      </mat-card>

      <mat-card class="species-chart">
        <mat-card-header>
          <mat-card-title>Wildlife — Species Observed</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-legend" *ngIf="speciesCounts.length">
            <div *ngFor="let s of speciesCounts" class="chart-row">
              <div class="label">{{ s.name }}</div>
              <div class="bar"><div class="bar-fill" [style.width.%]="widthPercent(s.count)"></div></div>
              <div class="count">{{ s.count }}</div>
            </div>
          </div>
          <div *ngIf="!speciesCounts.length" class="muted">No species data available.</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="time-series">
        <mat-card-header>
          <mat-card-title>Plantings Over Time</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div style="height:220px; position: relative;">
            <canvas id="plantingsChartCanvas"></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="recent-activity">
        <mat-card-header>
          <mat-card-title>Recent Activity (last 24h)</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <ul class="activity-list">
            <li *ngFor="let a of recentActivity">
              <strong>{{ a.user }}</strong>
              <span class="muted"> • </span>
              <em>{{ a.title }}</em>
              <span class="time">{{ a.time | date:'short' }}</span>
            </li>
            <li *ngIf="!recentActivity || recentActivity.length === 0" class="muted">No activity in the last 24 hours.</li>
          </ul>
        </mat-card-content>
      </mat-card>
      <mat-card class="quick-actions">
        <mat-card-header>
          <mat-card-title>Quick Actions</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="actions-grid">
            <button mat-mini-fab color="primary" aria-label="Join challenge" (click)="quickJoinChallenge()"><mat-icon>group_add</mat-icon></button>
            <button mat-mini-fab color="accent" aria-label="Create post" (click)="quickCreatePost()"><mat-icon>chat</mat-icon></button>
            <button mat-mini-fab color="primary" aria-label="Add resource" (click)="quickAddResource()"><mat-icon>library_add</mat-icon></button>
          </div>
          <div class="leaderboard" style="margin-top:18px;">
            <h4>Leaderboard</h4>
            <ol class="leader-list">
              <li *ngFor="let lb of leaderboard">
                <div class="leader-entry">
                  <div class="leader-left">
                    <div class="leader-avatar">
                      <img *ngIf="lb.avatarUrl; else leaderInitial" [src]="lb.avatarUrl" alt="avatar" />
                      <ng-template #leaderInitial>
                        <div class="leader-initial">{{ lb.name ? lb.name.charAt(0) : (lb.user_id || '?').charAt(0) }}</div>
                      </ng-template>
                    </div>
                    <div class="leader-name">{{ lb.name }}</div>
                  </div>
                  <div class="leader-score">{{ lb.score }}</div>
                </div>
              </li>
            </ol>
          </div>
        </mat-card-content>
      </mat-card>
    </section>
  </main>
</div>
